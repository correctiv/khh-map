<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <title>Krankenhaushygieniker-Karte</title>
  <link rel="stylesheet" href="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.12/themes/css/cartodb.css" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="map"></div>

  <script src="https://cartodb-libs.global.ssl.fastly.net/cartodb.js/v3/3.12/cartodb.js"></script>
  <script>

    cdb.geo.ui.Search = cdb.geo.ui.Search.extend({
      _submit: function(ev) {
        ev.preventDefault();
        var self = this;
        var address = this.$('input.text').val() + ', Germany';
        // Show geocoder loader
        this._showLoader();

        cdb.geo.geocoder.NOKIA.geocode(address, function(coords) {
          if (coords.length>0) {
            var validBBox = true;

            // check bounding box is valid
            if(!coords[0].boundingbox || coords[0].boundingbox.south == coords[0].boundingbox.north ||
              coords[0].boundingbox.east == coords[0].boundingbox.west) {
              validBBox = false;
            }
            if (validBBox && coords[0].boundingbox) {
              leafletMap.fitBounds([
                [
                  parseFloat(coords[0].boundingbox.south),
                  parseFloat(coords[0].boundingbox.west)
                ],
                [
                  parseFloat(coords[0].boundingbox.north),
                  parseFloat(coords[0].boundingbox.east)
                ]
              ]);
            } else if (coords[0].lat && coords[0].lon) {
              leafletMap.setCenter([coords[0].lat, coords[0].lon]);
              leafletMap.setZoom(10);
            }
          }
          // Hide geocoder loader
          self._hideLoader();
        });
      }
    });

  var leafletMap;

  window.onload = function() {

  cartodb.createVis('map', 'https://correctiv.cartodb.com/api/v2/viz/7e0f98ae-d41e-11e6-a550-0e98b61680bf/viz.json')
    .done(function(vis, layers) {
      var map = vis.map;
      map.set({
        minZoom: 5,
        maxZoom: 13
      });
      var bounds = [[47.2703, 5.8667],[54.0585, 15.0419]];
      var maxBounds = [[40.2703, 0.8667],[65.0585, 26.0419]];
      leafletMap = vis.getNativeMap();
      leafletMap.setMaxBounds(maxBounds);
      leafletMap.fitBounds(bounds);
      leafletMap.attributionControl.addAttribution('Visualisierung: <a target="_blank" href="https://correctiv.org">correctiv.org</a>');
    });
  };
  </script>
</body>
</html>
